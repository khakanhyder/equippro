# Wishlist Functionality - Complete User Flow

**Document Purpose:** This document provides a step-by-step walkthrough of the Wishlist feature, showing exactly what happens when users interact with each button and how the AI analysis workflow operates.

**Last Updated:** November 12, 2025

---

## Table of Contents
1. [Initial State - Opening the Dialog](#1-initial-state---opening-the-dialog)
2. [Image Upload](#2-image-upload)
3. [AI Analyze Button](#3-ai-analyze-button-3-step-workflow)
4. [Search External Sources Button](#4-search-external-sources-button)
5. [Get Price Context Button](#5-get-price-context-button)
6. [AI Suggestions - Accept/Ignore](#6-ai-suggestions---acceptignore)
7. [Per-Source Analyze Button](#7-per-source-analyze-button)
8. [Per-Source Save Button](#8-per-source-save-button)
9. [Form Validation & Save](#9-form-validation--save)
10. [Technical Reference](#10-technical-reference)

---

## 1. Initial State - Opening the Dialog

### What User Sees

When user clicks "Add Equipment Specification" on the Wishlist page, a dialog opens with:

**Form Fields:**
- **Brand** (text input) - *Required*
- **Model** (text input) - *Required*
- **Category** (dropdown) - *Required*
- **Preferred Condition** (dropdown) - *Required*
- **Location** (text input) - *Required*
- **Description** (textarea) - *Optional*
- **Technical Specifications** section with "Add" button
- **Maximum Budget** (number input) - *Optional*
- **Market Price Context** section
- **Priority** (dropdown: High/Medium/Low) - *Optional*
- **Images** upload area (right side)
- **Documents** section

**Buttons Visible:**
- âœ… **Search External Sources (PDFs + Google)** - *DISABLED* (requires brand + model)
- âœ… **Get Price Context** - *DISABLED* (requires brand + model)
- âœ… **Add** button for Technical Specifications
- âŒ **AI Analyze: Images â†’ Manuals â†’ Specifications** - *NOT VISIBLE* (appears only after image upload)

**State:**
```javascript
{
  images: [],
  formData: { brand: '', model: '', description: '', ... },
  suggestions: { brand: null, model: null, category: null, specifications: [] },
  foundManuals: [],
  priceContext: null
}
```

---

## 2. Image Upload

### User Action
1. User drags & drops images OR clicks "Drop images here or click to select"
2. File picker opens (accepts PNG, JPG up to 5MB, max 5 files)
3. User selects 1-5 images

### What Happens Behind the Scenes

**Frontend Processing:**
```javascript
// ObjectUploader component handles upload
handleImageUploadComplete(result) {
  // Append new images to existing array
  const newImages = result.successful.map(file => file.uploadURL);
  setImages(prev => [...prev, ...newImages]);
  
  // If FIRST image: reset all analysis states
  if (images.length === 0) {
    setAnalysisResults(null);
    setSuggestions({ brand: null, model: null, ... });
    setFoundManuals([]);
    setHasSearchedManuals(false);
  }
  // Note: Does NOT trigger automatic analysis
}
```

**Storage:**
- Images uploaded to Wasabi cloud storage
- Returns URLs like: `https://s3.wasabisys.com/.../equipment_image_123.jpg`
- URLs stored in component state

### â­ WHAT APPEARS AFTER IMAGE UPLOAD

**Visual Change - New Button Appears:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Images Section                                          â”‚
â”‚                                                         â”‚
â”‚ [Image 1]  [Image 2]  [Image 3]                        â”‚
â”‚  (150px)   (150px)    (150px)                          â”‚
â”‚   [X]       [X]        [X]                             â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ âœ¨ AI Analyze: Images â†’ Manuals â†’ Specs      â”‚     â”‚
â”‚  â”‚         (LARGE GRADIENT BUTTON)               â”‚     â”‚
â”‚  â”‚      Blue â†’ Purple, Prominent                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     ğŸ‘† THIS BUTTON ONLY APPEARS AFTER IMAGE UPLOAD     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UI State Changes:**
- âœ… **NEW UI ELEMENT:** Image thumbnails grid appears (150x150px each)
- âœ… **NEW UI ELEMENT:** Delete button (X) on each thumbnail
- âœ… **NEW BUTTON APPEARS:** "AI Analyze: Images â†’ Manuals â†’ Specifications"
  - **Condition to appear:** `images.length > 0` (at least 1 image uploaded)
  - **Style:** Large gradient button (blue to purple), eye-catching
  - **Location:** Below images section, separated by border
  - **Purpose:** Triggers 3-step AI workflow to extract brand, model, and specs

**Buttons Still Disabled:**
- ğŸ”’ Search External Sources (needs brand + model)
- ğŸ”’ Get Price Context (needs brand + model)

**Important:** NO automatic analysis happens. User must manually click "AI Analyze" button.

---

## 3. AI Analyze Button (3-Step Workflow)

### â­ WHEN THIS BUTTON APPEARS
- **Condition:** Only appears when `images.length > 0` (at least 1 image uploaded)
- **Label:** "AI Analyze: Images â†’ Manuals â†’ Specifications"
- **Style:** Large gradient button (blue to purple), prominent placement
- **Location:** Below the image upload area, separated by border
- **Purpose:** Extracts brand, model, category, and technical specifications from uploaded images

### User Action
User clicks the "AI Analyze: Images â†’ Manuals â†’ Specifications" button

### What Happens - Complete Flow

#### Step 1: Loading State
```
Button shows: [Spinner] "Analyzing: Images â†’ Manuals â†’ Specs..."
Button disabled during analysis
```

#### Step 2: API Call to `/analyze/complete-flow`

**Request:**
```javascript
POST /analyze/complete-flow
Content-Type: application/json

{
  "image_urls": [
    "https://s3.wasabisys.com/.../image1.jpg",
    "https://s3.wasabisys.com/.../image2.jpg"
  ],
  "brand": "Thermo Fisher",  // If user already entered
  "model": "TSQ Altis"        // If user already entered
}
```

**Backend Processing (equipment_analysis_api_simple.py):**

The backend executes a 3-step workflow:

##### **Phase 1: Image Analysis**
- Analyzes ALL uploaded images using OpenAI Vision API (GPT-4o)
- Extracts: brand, model, category, description
- Calculates confidence scores
- **Output:** Best brand/model detected

##### **Phase 2: Manual Search**
- Searches Google for product manuals (PDFs)
- Query: `"{brand} {model} (manual OR specification OR datasheet) filetype:pdf"`
- Downloads top 3 valid PDFs
- Extracts text content using pdfplumber
- **Output:** PDF URLs and extracted text

##### **Phase 3: Specification Extraction**
- Sends PDF text to OpenAI (GPT-4o-mini)
- Prompt asks for: dimensions, weight, power, voltage, operating conditions, etc.
- Returns structured JSON specifications
- **Output:** Array of { name, value, unit } objects

**Response:**
```json
{
  "success": true,
  "steps": {
    "image_analysis": {
      "completed": true,
      "confidence": 0.85,
      "brand": "Thermo Fisher",
      "model": "TSQ Altis"
    },
    "manual_search": {
      "completed": true,
      "pdfs_found": 2,
      "pdf_urls": ["https://...manual.pdf"]
    },
    "specification_extraction": {
      "completed": true,
      "specs_found": 8
    }
  },
  "final_result": {
    "brand": "Thermo Fisher",
    "model": "TSQ Altis",
    "category": "Mass Spectrometry",
    "specifications": [
      { "name": "Power", "value": "1500", "unit": "W" },
      { "name": "Voltage", "value": "220", "unit": "V AC" },
      { "name": "Weight", "value": "150", "unit": "kg" }
    ]
  }
}
```

#### Step 3: Display Suggestions

**What User Sees:**

1. **Brand Suggestion Box** (if brand detected):
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ âœ¨ AI Suggestion (85% confidence)      â”‚
   â”‚ Thermo Fisher                           â”‚
   â”‚ [Accept] [Ignore]                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

2. **Model Suggestion Box** (if model detected):
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ âœ¨ AI Suggestion (85% confidence)      â”‚
   â”‚ TSQ Altis                               â”‚
   â”‚ [Accept] [Ignore]                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **Category Suggestion Box** (if category detected):
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ âœ¨ AI Suggestion (90% confidence)      â”‚
   â”‚ Mass Spectrometry                       â”‚
   â”‚ [Accept] [Ignore]                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

4. **Specifications Suggestions** (array of specs):
   - Each specification shown with Accept/Ignore buttons
   - User can selectively accept individual specs

**Important:** Suggestions are NOT auto-filled. User must click "Accept" to populate form fields.

#### Step 4: Button State Returns to Normal
```
Button shows: "AI Analyze: Images â†’ Manuals â†’ Specifications"
Button enabled again for re-analysis
```

### Error Handling

**If Analysis Fails:**
- Alert shown: "Failed to analyze equipment. Please try again."
- Button returns to enabled state
- No suggestions displayed
- User can retry or fill form manually

**If Partial Success:**
- Brand/model suggestions shown even if specs failed
- User sees what was successfully extracted
- Missing data can be entered manually

---

## 4. Search External Sources Button

### â­ WHEN THIS BUTTON BECOMES ENABLED
- **Initial State:** DISABLED (gray, cannot click)
- **Trigger Condition:** Enabled when BOTH brand AND model fields are filled
- **Label:** "Search External Sources (PDFs + Google)"
- **Style:** Green outlined button (`bg-green-50 border-green-200 text-green-700`)
- **Icon:** BookOpen icon (ğŸ“–)
- **Location:** Below brand/model input fields

### User Action
1. User enters brand (e.g., "Thermo Fisher")
2. User enters model (e.g., "TSQ Altis")
3. Button becomes enabled (green, clickable)
4. User clicks "Search External Sources (PDFs + Google)"

### What Happens - Complete Flow

#### Step 1: Loading State
```
Button shows: [Spinner] "Searching External Sources..."
Button disabled during search
```

#### Step 2: API Call to `/match` Endpoint

**Request:**
```javascript
POST /match
Content-Type: application/json

{
  "brand": "Thermo Fisher",
  "model": "TSQ Altis",
  "search_pdfs": true  // Enables comprehensive external search
}
```

**Backend Processing (enhanced_matching_api.py):**

The Enhanced Matching API performs:

##### **PDF Search:**
- Uses Apify Google Search Scraper
- Query: `"Thermo Fisher TSQ Altis (manual OR specification OR datasheet) filetype:pdf"`
- Filters for valid PDF links
- Downloads and verifies PDFs
- Extracts relevance scores

##### **Google Web Search:**
- Searches for product pages, datasheets, manufacturer sites
- Extracts product information from web pages
- Scores relevance based on brand/model match
- Returns top results with descriptions

**Response:**
```json
{
  "success": true,
  "external_matches": [
    {
      "url": "https://assets.thermofisher.com/TFS-Assets/CMD/manuals/TSQ_Altis_Manual.pdf",
      "title": "TSQ Altis User Manual - Thermo Fisher Scientific",
      "brand": "Thermo Fisher",
      "model": "TSQ Altis",
      "confidence": 0.95,
      "provenance": "pdf_search",
      "description": "Official user manual for TSQ Altis triple quadrupole mass spectrometer"
    },
    {
      "url": "https://www.thermofisher.com/order/catalog/product/TSQ-ALTIS",
      "title": "TSQ Altis Product Page",
      "brand": "Thermo Fisher",
      "model": "TSQ Altis",
      "confidence": 0.88,
      "provenance": "web_search",
      "description": "Official product page with specifications and pricing"
    }
  ]
}
```

#### Step 3: â­ WHAT UI BOXES APPEAR AFTER SEARCH

**Trigger Condition for Green Panel to Appear:**
- **Path 1:** After clicking "Search External Sources" button (fresh search completed)
- **Path 2:** When editing existing wishlist item with saved external sources (auto-loaded)
- **State Variable:** `hasSearchedManuals` = true

**A GREEN ALERT PANEL APPEARS:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ğŸŸ¢ GREEN BOX (bg-green-50, border-green-200)        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“– Found 2 External Source(s)     âœ“ 1/2 Analyzed                â”‚ â”‚
â”‚ â”‚    (header in green-800)           (if PDFs analyzed)            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  SOURCE CARD 1 (white bg, green border, rounded)             â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  TSQ Altis User Manual - Thermo Fisher Scientific            â”‚   â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚ â”‚  â”‚ ğŸ“„ PDF Manual    â”‚ â”‚ 95% Match      â”‚  (badges)           â”‚   â”‚
â”‚ â”‚  â”‚ (purple badge)   â”‚ â”‚ (green badge)  â”‚                     â”‚   â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  Official user manual for TSQ Altis triple quadrupole...     â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  ğŸ’° Price detected: $95,000 (if found)                        â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  ğŸ”— https://assets.thermofisher.com/.../TSQ_Altis_Manual.pdf â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚ â”‚  â”‚ Analyze  â”‚ â”‚   Save   â”‚                                   â”‚   â”‚
â”‚ â”‚  â”‚ (purple) â”‚ â”‚  (green) â”‚  â† ACTION BUTTONS                 â”‚   â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  SOURCE CARD 2 (white bg, green border, rounded)             â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  TSQ Altis Product Page                                      â”‚   â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚ â”‚  â”‚ ğŸ›’ Product Page  â”‚ â”‚ 88% Match      â”‚                     â”‚   â”‚
â”‚ â”‚  â”‚ (emerald badge)  â”‚ â”‚ (yellow badge) â”‚                     â”‚   â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  Official product page with specifications and pricing       â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  ğŸ”— https://www.thermofisher.com/order/catalog/product/...   â”‚   â”‚
â”‚ â”‚                                                                â”‚   â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚ â”‚  â”‚ Analyze  â”‚ â”‚   Save   â”‚                                   â”‚   â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  (Max height: 60vh, scrollable if more sources)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UI ELEMENTS BREAKDOWN:**

**1. GREEN PANEL CONTAINER** (`hasSearchedManuals` state = true)
   - Background: Light green (`bg-green-50`)
   - Border: Green (`border-green-200`)
   - Padding: 16px
   - Rounded corners

**2. HEADER SECTION**
   - ğŸ“– BookOpen icon (green)
   - Text: "Found X External Source(s)" (or "No External Sources Found")
   - Font: Semibold, green-800
   - Right side: PDF Analysis Summary badge (if applicable)
     - Shows: "âœ“ 1/2 Analyzed" 
     - Style: White background, green border

**3. SOURCE CARDS** (individual white boxes)
   Each card contains:
   
   a) **Title** (clickable link)
      - Font: Medium, gray-900
      - Opens in new tab when clicked
   
   b) **Result Type Badge** (color-coded)
      - ğŸ“„ PDF Manual (purple: `bg-purple-100 text-purple-800`)
      - ğŸ›’ Product Page (emerald: `bg-emerald-100 text-emerald-800`)
      - ğŸ“‹ Datasheet (indigo: `bg-indigo-100 text-indigo-800`)
      - ğŸ’° Commercial (gray: `bg-gray-100 text-gray-800`)
   
   c) **Relevance Score Badge** (confidence %)
      - High (â‰¥90%): Green badge (`bg-green-100 text-green-800`)
      - Medium (70-89%): Blue badge (`bg-blue-100 text-blue-800`)
      - Low (<70%): Yellow badge (`bg-yellow-100 text-yellow-800`)
   
   d) **Description** (gray text)
      - Brief summary of source
   
   e) **Price** (if detected)
      - Format: "ğŸ’° Price detected: $XX,XXX"
      - Only shown if price found in source
   
   f) **URL** (clickable link in gray box)
      - Gray background box (`bg-gray-50 border-gray-200`)
      - ExternalLink icon (blue)
      - Full URL displayed
      - Opens in new tab when clicked
   
   g) **Action Buttons** (bottom of card)
      - **[Analyze]** - Purple outlined button
        - Extracts specifications from THIS source
        - Changes to "âœ“ Analyzed" when done
      - **[Save]** - Green outlined button
        - Saves source for future reference
        - Changes to "Saved" (grayed) when done

**4. EMPTY STATE** (if no sources found)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¢ GREEN BOX (bg-green-50, border-green-200)                 â”‚
â”‚                                                               â”‚
â”‚  ğŸ“– No External Sources Found                                 â”‚
â”‚                                                               â”‚
â”‚  No user manuals found for this equipment. Try searching     â”‚
â”‚  with different terms or check the manufacturer's website.   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step 4: Price Calculation from External Sources

Backend also attempts to extract prices from found sources:

```javascript
// If prices found in external sources:
calculatePriceFromExternalSources(matches) {
  // Extracts prices from product pages
  // Averages prices by condition (new/used/refurbished)
  // Updates formData.market_price_range automatically
}
```

**If prices found:**
- Price ranges auto-populate in Market Price Context section
- PriceBar component updates to show ranges
- No user action required

#### Step 5: Button State Returns to Normal
```
Button shows: "Search External Sources (PDFs + Google)"
Button enabled for re-search
```

### Error Handling

**If Search Fails:**
- Alert shown: "Failed to search external sources: [error message]"
- Button returns to enabled state
- No sources displayed

**If No Results Found:**
- Message shown: "No external results found"
- Empty state displayed
- User can proceed with manual entry

---

## 5. Get Price Context Button

### â­ WHEN THIS BUTTON BECOMES ENABLED
- **Initial State:** DISABLED (gray, cannot click)
- **Trigger Condition:** Enabled when BOTH brand AND model fields are filled
- **Label:** "âœ¨ Get Price Context"
- **Style:** Outlined button with sparkle emoji
- **Location:** Under "Market Price Context" section, next to DEV MODE toggle

### User Action
1. User enters brand (e.g., "Thermo Fisher")
2. User enters model (e.g., "TSQ Altis")
3. (Optional) User enters specifications for more accurate pricing
4. Button becomes enabled
5. User clicks "âœ¨ Get Price Context"

### What Happens - Complete Flow

#### Step 1: Loading State
```
Button shows: [Spinner] "Getting Price Context..."
Button disabled during fetch
```

#### Step 2: API Call to `/api/estimate-equipment-price`

**Request:**
```javascript
POST /api/estimate-equipment-price
Content-Type: application/json

{
  "brand": "Thermo Fisher",
  "model": "TSQ Altis",
  "category": "Mass Spectrometry",
  "location": "United States",
  "specifications": {
    "Power": "1500W",
    "Weight": "150 kg",
    "Voltage": "220V AC"
  }
}
```

**Backend Processing (price_api.py):**

The Price API executes:

##### **Step 1: URL Price Fetcher**
- Searches Google for: `"Thermo Fisher TSQ Altis" price buy sell`
- Fetches top 10 product listing pages
- Extracts prices using regex patterns
- Filters out shipping costs, spare parts
- Categorizes by condition (new/used/refurbished)

##### **Step 2: Price Aggregation**
- Groups prices by condition
- Calculates min/max ranges
- Removes outliers (>2 standard deviations)
- Computes average prices

##### **Step 3: Shipping & Crating Estimation**
- Estimates weight from specifications
- Calculates crating cost based on dimensions
- Estimates shipping cost based on weight + location

##### **Step 4: AI Price Estimation (Fallback)**
- If no market prices found, uses OpenAI
- Provides AI-generated estimate with disclaimer

**Response:**
```json
{
  "success": true,
  "price_source": "aggregated_from_products",
  "new_min": 85000,
  "new_max": 120000,
  "refurbished_min": 50000,
  "refurbished_max": 75000,
  "used_min": 30000,
  "used_max": 55000,
  "estimated_crating_cost": 1200,
  "estimated_shipping_cost": 3500,
  "market_notes": "Prices based on 8 current listings from eBay, LabX, and manufacturer sites",
  "price_breakdown": {
    "new": {
      "sources": 3,
      "prices": [85000, 95000, 120000],
      "average": 100000
    },
    "used": {
      "sources": 5,
      "prices": [30000, 38000, 45000, 52000, 55000],
      "average": 44000
    }
  },
  "_debug": {
    "urls_fetched": 10,
    "prices_extracted": 8,
    "query_used": "Thermo Fisher TSQ Altis price buy sell"
  }
}
```

#### Step 3: Display Price Context

**What User Sees:**

##### **PriceBar Component** (Visual Representation):

```
Market Price Context
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Budget: $45,000
                  â†“ Budget
New         [$85K â”â”â”â”â”â”â”â”â”â”â”â” $120K]
Refurb      [$50K â”â”â”â”â” $75K]
Used        [$30K â”â”â” $55K]
                    â†‘ Budget falls here
```

The PriceBar shows:
- **Budget value** as header chip above the bar
- **Three condition ranges** (New/Refurbished/Used) as horizontal bars
- **Budget position** indicated by vertical alignment
- **Color coding:**
  - Green bars: Budget is realistic for this condition
  - Yellow bars: Budget is borderline
  - Red bars: Budget is too low for this condition

##### **Text Information:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market Price Ranges                            â”‚
â”‚ â€¢ New: $85,000 - $120,000 (avg: $100,000)      â”‚
â”‚ â€¢ Refurbished: $50,000 - $75,000 (avg: $62,500)â”‚
â”‚ â€¢ Used: $30,000 - $55,000 (avg: $44,000)       â”‚
â”‚                                                 â”‚
â”‚ Estimated Shipping: $3,500                     â”‚
â”‚ Estimated Crating: $1,200                      â”‚
â”‚                                                 â”‚
â”‚ â„¹ï¸ Prices based on 8 current listings from     â”‚
â”‚   eBay, LabX, and manufacturer sites           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### **DEV MODE** (Debug Panel):

If user clicks "ğŸ”§" button, additional debug info shown:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ Price Context API Debug                     â”‚
â”‚                                                 â”‚
â”‚ URLs Fetched: 10                               â”‚
â”‚ Prices Extracted: 8                            â”‚
â”‚ Query Used: "Thermo Fisher TSQ Altis price..."â”‚
â”‚                                                 â”‚
â”‚ Price Breakdown:                               â”‚
â”‚ â€¢ New: 3 sources, [85K, 95K, 120K]            â”‚
â”‚ â€¢ Used: 5 sources, [30K, 38K, 45K, 52K, 55K]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step 4: Form Data Update

Price context automatically populates hidden form fields:

```javascript
formData.market_price_range = {
  new_min: 85000,
  new_max: 120000,
  refurbished_min: 50000,
  refurbished_max: 75000,
  used_min: 30000,
  used_max: 55000
}
formData.estimated_crating_cost = 1200
formData.estimated_shipping_cost = 3500
formData.market_notes = "Prices based on 8 current listings..."
```

These values are saved with the wishlist item.

#### Step 5: Button State Returns to Normal
```
Button shows: "âœ¨ Get Price Context"
Button enabled for refresh
```

### Price Source Indicators

**Real Market Data:**
```
âœ… Source: Real market prices (aggregated from products)
â„¹ï¸ Prices based on 8 current listings from eBay, LabX...
```

**AI Estimate (Fallback):**
```
âš ï¸ Source: AI-generated estimate
â„¹ï¸ No market data found. These are AI-estimated ranges based on similar equipment.
```

### Error Handling

**If Price Fetch Fails:**
- Alert shown: "Failed to get price context. Please try again."
- Button returns to enabled state
- Previous price data (if any) remains displayed

**If No Prices Found:**
- Falls back to AI estimation
- Shows warning indicator
- Provides conservative price ranges

---

## 6. AI Suggestions - Accept/Ignore

### Suggestion Box Appearance

After AI analysis completes (Step 3), suggestion boxes appear for each detected field:

**Normal Suggestion (Data Found):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ¨ AI Suggestion (85% confidence)           â”‚
â”‚ Thermo Fisher                                â”‚
â”‚                          [Accept]  [Ignore]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Empty Result (No Data Found):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ AI Analysis Result                        â”‚
â”‚ Could not identify brand from images         â”‚
â”‚                                  [Dismiss]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Actions

#### Clicking "Accept"

**What Happens:**
1. Suggested value copied to form field
2. Suggestion box disappears
3. Field becomes editable (user can still modify)

**Example:**
```javascript
// Before Accept
formData.brand = ""
suggestions.brand = { value: "Thermo Fisher", confidence: 0.85 }

// After Accept
formData.brand = "Thermo Fisher"
suggestions.brand = null  // Suggestion cleared
```

**UI Change:**
- Brand input field now shows: "Thermo Fisher"
- Suggestion box removed
- User can edit if needed

#### Clicking "Ignore"

**What Happens:**
1. Suggestion box disappears
2. Form field remains empty (or unchanged)
3. User can manually enter value

**Example:**
```javascript
// Before Ignore
formData.brand = ""
suggestions.brand = { value: "Thermo Fisher", confidence: 0.85 }

// After Ignore
formData.brand = ""  // Still empty
suggestions.brand = null  // Suggestion cleared
```

**UI Change:**
- Suggestion box removed
- Field remains empty
- User proceeds with manual entry

#### Clicking "Dismiss" (Empty Result)

**What Happens:**
1. Warning box disappears
2. No data change
3. User acknowledges AI couldn't find data

### Specifications Suggestions

For specifications, the flow is different:

**Display:**
```
Technical Specifications
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ¨ AI Suggestions (8 specifications found)  â”‚
â”‚                                              â”‚
â”‚ â€¢ Power: 1500 W              [Accept] [Ignore]â”‚
â”‚ â€¢ Voltage: 220 V AC          [Accept] [Ignore]â”‚
â”‚ â€¢ Weight: 150 kg             [Accept] [Ignore]â”‚
â”‚ â€¢ Dimensions: 60x50x40 cm    [Accept] [Ignore]â”‚
â”‚ ...                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Accept Individual Spec:**
- Adds that spec to Technical Specifications table
- Removes suggestion for that spec only
- Other specs remain suggested

**Ignore Individual Spec:**
- Removes suggestion for that spec
- Does not add to table
- Other specs remain suggested

**Final Result:**
- User can cherry-pick which specs to accept
- Accepted specs appear in editable table
- User can still modify accepted specs

---

## 7. Per-Source Analyze Button

### Button Appearance
- **Label:** "Analyze"
- **Style:** Small purple outlined button with sparkle icon
- **Condition:** Always enabled for each external source
- **Location:** Next to each source in External Sources list

### User Action
User clicks "Analyze" button for a specific external source

### What Happens - Complete Flow

#### Step 1: Loading State
```
Button shows: [Spinner] "Analyzing..."
Button disabled during analysis
Other source buttons remain enabled
```

#### Step 2: API Call to `/analyze/external-source`

**Request:**
```javascript
POST /analyze/external-source
Content-Type: application/json

{
  "url": "https://assets.thermofisher.com/.../manual.pdf",
  "source_type": "pdf",  // or "web"
  "brand": "Thermo Fisher",
  "model": "TSQ Altis"
}
```

**Backend Processing:**

##### **For PDF Sources:**
1. Download PDF from URL
2. Extract text using pdfplumber
3. Send text to OpenAI with prompt:
   ```
   Extract technical specifications from this equipment manual.
   Focus on: dimensions, weight, power, voltage, operating conditions, etc.
   Return as JSON array: [{ name, value, unit }, ...]
   ```
4. Parse response into structured specs

##### **For Web Sources:**
1. Fetch HTML from URL
2. Extract main content text
3. Send to OpenAI with same prompt
4. Parse specifications

**Response:**
```json
{
  "success": true,
  "specifications": [
    { "name": "Power", "value": "1500", "unit": "W" },
    { "name": "Voltage", "value": "220", "unit": "V AC" },
    { "name": "Weight", "value": "150", "unit": "kg" },
    { "name": "Operating Temperature", "value": "15-30", "unit": "Â°C" }
  ],
  "category": "Mass Spectrometry"
}
```

#### Step 3: Display Results

**What User Sees:**

Specifications appear as suggestions below the source:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ TSQ Altis User Manual                           â”‚
â”‚    https://assets.thermofisher.com/.../manual.pdf  â”‚
â”‚    [âœ“ Analyzed] [Save]                             â”‚
â”‚                                                     â”‚
â”‚    âœ¨ Extracted Specifications (4 found):          â”‚
â”‚    â€¢ Power: 1500 W                    [Accept]     â”‚
â”‚    â€¢ Voltage: 220 V AC                [Accept]     â”‚
â”‚    â€¢ Weight: 150 kg                   [Accept]     â”‚
â”‚    â€¢ Operating Temperature: 15-30 Â°C  [Accept]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Category Update:**
- If category extracted and form field empty, suggests category
- User can accept or ignore

**Specifications:**
- Each spec shown with Accept button
- Clicking Accept adds to Technical Specifications table
- Specs from multiple sources can be combined

#### Step 4: Button Changes
```
Button shows: "âœ“ Analyzed" (with checkmark)
Button disabled (already analyzed)
```

### Error Handling

**If Analysis Fails:**
- Alert shown: "Failed to analyze this source"
- Button returns to "Analyze" state
- User can retry

**If No Specs Found:**
- Message shown: "No specifications extracted from this source"
- Button shows "âœ“ Analyzed" (disabled)
- User can try other sources

---

## 8. Per-Source Save Button

### Button Appearance
- **Label:** "Save"
- **Style:** Small green outlined button with save icon
- **Condition:** Enabled until clicked, then disabled
- **Location:** Next to "Analyze" button for each source

### User Action
User clicks "Save" button for a specific external source

### What Happens - Complete Flow

#### Step 1: Save to Database

**API Call:**
```javascript
POST /api/save-external-source
Content-Type: application/json

{
  "wishlist_item_id": 123,
  "source": {
    "url": "https://assets.thermofisher.com/.../manual.pdf",
    "title": "TSQ Altis User Manual",
    "source_type": "pdf_search",
    "confidence": 0.95,
    "brand": "Thermo Fisher",
    "model": "TSQ Altis"
  }
}
```

**Backend:**
- Stores source in `wishlist_external_sources` table
- Links to current wishlist item
- Marks as saved

#### Step 2: UI Update

**Button Changes:**
```
Before: [Save]  (green, enabled)
After:  [Saved] (gray, disabled)
```

**Visual Indicator:**
- Checkmark icon appears
- Button text changes to "Saved"
- Button grayed out
- Tooltip: "Already saved"

#### Step 3: Document Reference

Saved source appears in "Documents" section at bottom of dialog:

```
Documents
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Saved External Sources (1)             â”‚
â”‚                                            â”‚
â”‚ 1. TSQ Altis User Manual (PDF)            â”‚
â”‚    https://assets.thermofisher.com/...    â”‚
â”‚    Confidence: 95% | Saved: Nov 12, 2025  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Purpose of Saving

**Why Save Sources:**
- Creates permanent reference for this equipment
- Useful for future lookups
- Can be analyzed later
- Helps with equipment matching
- Provides provenance for specifications

**Where Saved Sources Appear:**
1. In this dialog under "Documents" section
2. In wishlist item detail view
3. Available when editing this wishlist item later
4. Can be used for marketplace matching

---

## 9. Form Validation & Save

### Required Fields

**Must be filled to enable Save button:**
- âœ… Brand (text, min 2 characters)
- âœ… Model (text, min 1 character)
- âœ… Category (dropdown selection)
- âœ… Preferred Condition (dropdown: New/Refurbished/Used/Any)
- âœ… Location (text, e.g., "Boston, MA" or "United States")

**Optional but recommended:**
- Description
- Technical Specifications (at least 1)
- Maximum Budget
- Images (at least 1)
- Priority (High/Medium/Low)

### Save Button State

**Disabled When:**
- Brand is empty
- Model is empty
- Category is not selected
- Preferred Condition is not selected
- Location is empty

**Enabled When:**
- All 5 required fields are filled:
  - Brand (min 2 characters)
  - Model (min 1 character)  
  - Category (dropdown selected)
  - Preferred Condition (dropdown selected)
  - Location (min 1 character)

### User Clicks Save

#### Action Button Label
- **If new item:** "Add to Project"
- **If editing:** "Save Changes"

#### What Happens

**1. Form Data Preparation:**
```javascript
const wishlistData = {
  brand: "Thermo Fisher",
  model: "TSQ Altis",
  description: "Triple quadrupole mass spectrometer for...",
  category: "Mass Spectrometry",
  technical_specifications: {
    "Power": "1500W",
    "Voltage": "220V AC",
    "Weight": "150 kg"
  },
  maximum_budget: 45000,
  market_price_range: {
    new_min: 85000,
    new_max: 120000,
    refurbished_min: 50000,
    refurbished_max: 75000,
    used_min: 30000,
    used_max: 55000
  },
  estimated_crating_cost: 1200,
  estimated_shipping_cost: 3500,
  market_notes: "Prices based on 8 current listings...",
  priority: "high",
  images: ["url1", "url2", "url3"],
  image_analysis_confidence: 0.85
}
```

**2. API Call:**
```javascript
// If new item
POST /api/wishlists
Content-Type: application/json
Body: wishlistData

// If editing
PUT /api/wishlists/{id}
Content-Type: application/json
Body: wishlistData
```

**3. Database Save:**
- Inserts/updates row in `wishlists` table
- Stores specifications as JSONB
- Stores price ranges as JSONB
- Links saved external sources
- Saves image URLs array

**4. Success:**
- Dialog closes
- Success toast: "Equipment added to wishlist!" or "Changes saved!"
- Wishlist page refreshes
- New item appears in list

**5. Trigger Matching:**
- Backend automatically triggers AI matching
- Searches for matching equipment in surplus listings
- Compares specifications
- Calculates match scores
- Returns match results

---

## 10. Technical Reference

### Frontend Components

**Main Files:**
- `src/components/wishlist/Wishlist.jsx` - Main wishlist page
- `src/components/wishlist/EditWishlistItemDialog.jsx` - Add/Edit dialog (this document focuses here)
- `src/components/wishlist/AIAnalysisDetailsDialog.jsx` - Shows detailed analysis results
- `src/components/shared/ObjectUploader.jsx` - Image upload component
- `src/components/shared/PriceBar.jsx` - Price visualization component

### Backend APIs

**Analysis API** (equipment_analysis_api_simple.py):
- `POST /analyze/complete-flow` - 3-step AI analysis (images â†’ manuals â†’ specs)
- `POST /analyze-image` - Image-only analysis (simplified)
- `POST /analyze/external-source` - Analyze specific PDF/web source

**Enhanced Matching API** (enhanced_matching_api.py):
- `POST /match` - Find matches for equipment + external source search
- `GET /match/{wishlist_id}/matches` - Get matches for specific wishlist item

**Price API** (price_api.py):
- `POST /api/estimate-equipment-price` - Get market prices + shipping estimates
- Uses URL price fetcher + Google search
- Falls back to AI estimation if no prices found

**Wishlist API** (server/api/wishlists.js):
- `GET /api/wishlists` - List all wishlist items
- `POST /api/wishlists` - Create new wishlist item
- `PUT /api/wishlists/{id}` - Update existing item
- `DELETE /api/wishlists/{id}` - Delete item
- `POST /api/save-external-source` - Save external source reference

### State Management

**Key State Variables:**
```javascript
const [formData, setFormData] = useState({
  brand: '',
  model: '',
  description: '',
  category: '',
  technical_specifications: {},
  maximum_budget: null,
  market_price_range: { new_min, new_max, refurb_min, refurb_max, used_min, used_max },
  estimated_crating_cost: null,
  estimated_shipping_cost: null,
  market_notes: '',
  priority: 'medium',
  images: []
});

const [suggestions, setSuggestions] = useState({
  brand: null,
  model: null,
  category: null,
  description: null,
  specifications: []
});

const [foundManuals, setFoundManuals] = useState([]);
const [priceContext, setPriceContext] = useState(null);
const [isAnalyzingImages, setIsAnalyzingImages] = useState(false);
const [isSearchingManuals, setIsSearchingManuals] = useState(false);
const [isGettingPrice, setIsGettingPrice] = useState(false);
```

### Data Flow Summary

```
User Upload Images
    â†“
Images stored in Wasabi
    â†“
[AI Analyze Button Appears]
    â†“
User clicks AI Analyze
    â†“
POST /analyze/complete-flow
    â†“
Backend: Image Analysis â†’ PDF Search â†’ Spec Extraction
    â†“
Frontend: Display Suggestions
    â†“
User Accepts/Ignores Suggestions
    â†“
[Optional] User clicks Search External Sources
    â†“
POST /match (with search_pdfs=true)
    â†“
Backend: Google PDF + Web Search
    â†“
Frontend: Display External Sources List
    â†“
[Optional] User clicks Analyze on specific source
    â†“
POST /analyze/external-source
    â†“
Backend: Extract specs from that source
    â†“
Frontend: Display source-specific suggestions
    â†“
[Optional] User clicks Get Price Context
    â†“
POST /api/estimate-equipment-price
    â†“
Backend: URL price fetch + aggregation
    â†“
Frontend: Display PriceBar + price ranges
    â†“
User fills remaining fields manually
    â†“
User clicks Save/Add to Project
    â†“
POST /api/wishlists (or PUT for edit)
    â†“
Backend: Save to database + trigger matching
    â†“
Success: Dialog closes, wishlist refreshes
```

---

## Key Differences: Wishlist vs Surplus

| Feature | Wishlist | Surplus |
|---------|----------|---------|
| **AI Analysis** | 3-step workflow (images â†’ manuals â†’ specs) | Simple image analysis only |
| **Endpoint** | `/analyze/complete-flow` | `/analyze-image` |
| **PDF Search** | Yes, via "Search External Sources" | No |
| **Spec Extraction** | Yes, from PDFs and web pages | Suggestions only |
| **Price Context** | Yes, "Get Price Context" button | Yes, same button |
| **Auto-fill** | No, suggestions with Accept/Ignore | No, suggestions with Apply |
| **External Sources** | Can analyze individual sources | Not available |
| **Matching** | Automatic after save | N/A (Surplus is source) |

---

## Common User Workflows

### Workflow 1: Minimal Manual Entry
1. Upload images
2. Click "AI Analyze"
3. Accept all suggestions
4. Click "Save"
âœ… **Time: ~30 seconds**

### Workflow 2: With External Validation
1. Upload images
2. Click "AI Analyze"
3. Click "Search External Sources"
4. Click "Analyze" on official manual
5. Accept combined suggestions
6. Click "Get Price Context"
7. Review prices vs budget
8. Click "Save"
âœ… **Time: ~2 minutes**

### Workflow 3: Fully Manual
1. Manually type brand + model
2. Click "Search External Sources"
3. Review found sources
4. Click "Analyze" on best source
5. Accept specifications
6. Click "Get Price Context"
7. Adjust budget if needed
8. Click "Save"
âœ… **Time: ~3 minutes** (no image analysis needed)

### Workflow 4: Research-Heavy
1. Upload multiple images
2. Click "AI Analyze"
3. Click "Search External Sources"
4. Analyze multiple sources
5. Cherry-pick best specs from each
6. Click "Get Price Context"
7. Save external sources for reference
8. Add custom specifications
9. Write detailed description
10. Click "Save"
âœ… **Time: ~5-10 minutes** (comprehensive data)

---

## Error States & Troubleshooting

### "AI Analyze button not appearing"
**Cause:** No images uploaded  
**Solution:** Upload at least 1 image

### "Search External Sources button disabled"
**Cause:** Brand or model field empty  
**Solution:** Fill both brand and model fields

### "Get Price Context button disabled"
**Cause:** Brand or model field empty  
**Solution:** Fill both brand and model fields

### "No specifications extracted"
**Cause:** PDF/source doesn't contain spec tables  
**Solution:** Try other sources or add specs manually

### "No external sources found"
**Cause:** Uncommon equipment or misspelled brand/model  
**Solution:** Check spelling, try alternate model names

### "Price context shows AI estimate"
**Cause:** No market listings found  
**Solution:** Normal for rare equipment, estimate is conservative

### "Save button disabled"
**Cause:** Missing required fields (brand or model)  
**Solution:** Fill brand and model (minimum requirements)

---

**End of Document**
